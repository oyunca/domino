function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,o,a=[],i=!0,s=!1;try{for(r=r.call(e);!(i=(n=r.next()).done)&&(a.push(n.value),!t||a.length!==t);i=!0);}catch(e){s=!0,o=e}finally{try{i||null==r.return||r.return()}finally{if(s)throw o}}return a}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function ownKeys(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,n)}return r}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(r),!0).forEach(function(e){_defineProperty(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}define(["dpz.config","paymentmodules/dpz.globalPayments.constants"],function(e,t){function r(e){jsDPZ.topic(a.NEW_INTENT).publish(e)}function n(e){jsDPZ.topic(a.DELETE_INTENT).publish(e)}var m=e.getMarketProperty,o=t.amountStatuses,a=t.topics,i=m("payment"),s=i.nonSupportedPayments,c=void 0===s?[]:s,u=i.splitPayments.enabled;return{addPaymentIntent:r,bindAvailableContactless:function(e,t,r){var n=jsDPZ.app.store.getStore(),o=jsDPZ.app.order.getOrder(),a=n.data,i=a.ContactlessCarryout,s=a.ContactlessDelivery,c=o.data.Details.ServiceMethod;t&&"AVAILABLE"===("Delivery"===c?s:i)&&e.length&&(document.removeEventListener("toggledContactless",r),document.addEventListener("toggledContactless",r))},bindSplitPaymentEvents:function(e){var t=e.module;if(u){jsDPZ.topic(a.UPDATE_PROVIDERS).unsubscribe(t.updateProviders).subscribe(t.updateProviders),jsDPZ.topic(a.START_TRANSACTION).unsubscribe(t.startTransaction).subscribe(t.startTransaction),t.continueTransaction&&jsDPZ.topic(a.CONTINUE_TRANSACTION).unsubscribe(t.continueTransaction).subscribe(t.continueTransaction),jsDPZ.topic(a.RENDER_CHECKOUT).subscribe(function e(){jsDPZ.topic(a.RENDER_CHECKOUT).unsubscribe(e),jsDPZ.topic(a.UPDATE_PROVIDERS).unsubscribe(t.updateProviders),jsDPZ.topic(a.START_TRANSACTION).unsubscribe(t.startTransaction),t.continueTransaction&&jsDPZ.topic(a.CONTINUE_TRANSACTION).unsubscribe(t.continueTransaction)})}},buildRedirectUrl:function(e){var t=e.appLinkScheme,r=e.paymentProviderId,n=e.cartId,o=e.gpmPaymentType,a=e.gpmPaymentSubType,i=e.usePaymentRedirectLandingPage,s=void 0!==i&&i,c=e.isHybrid,u=void 0!==c&&c,l=urlConfig.root,d=m("market-identification").urls[0],p=s?"payment-redirect":"payment",y=t?"&scheme=".concat(encodeURIComponent(t)):"",f=u?"&hybrid=true":"";return"https://".concat(window.location.hostname).concat("localhost"===envConfig?":8443":"").concat(l,"/pages/order/").concat(p,"?cartid=").concat(encodeURIComponent(n),"&paymentProviderId=").concat(encodeURIComponent(r),"&redirect=payment&marketUrl=").concat(encodeURIComponent(d),"&gpmPaymentType=").concat(encodeURIComponent(o),"&gpmPaymentSubType=").concat(encodeURIComponent(a||o)).concat(y).concat(f)},createTransaction:function(e){var t=e.sessionId,r=e.transactions,n=e.transaction;jsDPZ.ajax.createPaymentSessionTransaction({sessionId:t,data:{transactions:r}}).then(jsDPZ.topic(a.UPDATE_TRANSACTION).publish,function(){return jsDPZ.topic(a.UPDATE_TRANSACTION).publish(_objectSpread(_objectSpread({},n),{},{status:n.ERROR}))})},errorOverlay:function(e,t,r){var n,o=2<arguments.length&&void 0!==r&&r,a=e,i=[m("payment").callCenterPhone||site.format.phoneNumber({number:jsDPZ.app.store.getStore().data.Phone},"storePhone")];null!=t&&null!==(n=t.response)&&void 0!==n&&n.responseMessage&&!o?(a="eServerMessage",i="Error Reason: ".concat(jsDPZ.util.htmlEscape(t.response.responseMessage)).concat(t.id?" <br>Transaction Reference: ".concat(t.id):"")):null!=t&&t.id&&"eCreditCardRefundTriggered"!==a&&(i=[t.id.toString()].concat(_toConsumableArray(i))),site.func.overlayToggle(!0,"codeOverlay",{},{code:a,label:i},function(){site.func.setupLayerCloseEvents({closeSelector:".js-closeButton",layerSelector:".js-cardOverlay",callback:function(){u||(window.location="".concat(urlConfig.localRoot,"/pages/order/payment"))}})}),"eCreditCardRefundTriggered"===a&&jsDPZ.topic("order.payment.refund").publish()},fetchCards:function(e){var t=e.canUseCards,r=void 0===t||t,n=e.isProfiled,o=e.provider;return n&&r?new Promise(function(t,e){jsDPZ.app.customer.getCustomer().fetchCreditCard().then(function(e){t(o?e.filter(function(e){return e.provider===o}):e)}).catch(function(){return e([])})}):Promise.resolve([])},getGPMTransactionNumber:function(e){var t=e.payment,r=t.gpmTransactionNumber,n=t.Type,o=e.order.gpmTransactionNumber;return u&&c.includes(n.toLowerCase())?r:o},getHasIntentsOrTransactions:function(e){var t=e.providers;return(void 0===t?[]:t).some(function(){var e=(0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}).amounts,t=_slicedToArray(e=void 0===e?[]:e,1)[0].status;return[o.SELECTED,o.IN_PROGRESS].includes(t)})},isContactlessEnabled:function(){var e=jsDPZ.app.order.getOrder().data.Details.ServiceMethod;return killConfig.isMarketEnabled("contactless-".concat(e.toLowerCase(),"-orders"))},isSplitPaymentsEnabled:function(){return u},onProviderSelectionUpdate:function(e){var t=e.intent;e.selected?r(t):n(t)},persistOrder:function(){return jsDPZ.ajax.sessionSave({id:"",data:$.extend({},jsDPZ.app.order.getOrder().data,{Fulfiller:{Groups:[]}}),async:!0}).fail(site.func.powerCommunicationError)},removePaymentIntent:n,setGPMTransactionId:function(e){var t=e.gpmTransactionId;jsDPZ.util.sessionStorage("gpmTransactionNumber",t)},showIframe:function(e,a,i){site.func.overlayToggle(!0,"iFrameOverlay",{keepCentered:!1,xPos:1,yPos:1},_objectSpread({},e),function(){$(window).on("message",function e(t){var r=t.originalEvent,n=JSON.parse(r.data),o="";if(r.origin===window.location.origin&&"signal.iFrameCloseEvent"===n.message){$(window).off("message",e);try{o=n.params.match(/(?:\??&?codTrans=)([^&]*)/)[1]}catch(e){o=null}site.func.overlayToggle(!1),site.func.toggleLoading("golopayment",!0),a.fetch($.extend({},i.checkStatusAjaxSettings,{transactionId:o,pollStatus:"WAITING_CONFIRMATION"})).always(function(e){a.handle(e)})}}),$(window).trigger("scroll.layer"),setTimeout(function(){site.func.overlayToggle(!1),window.location.reload()},9e5)})}}});
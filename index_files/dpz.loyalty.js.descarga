function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);return"Object"===a&&e.constructor&&(a=e.constructor.name),"Map"===a||"Set"===a?Array.from(e):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}function _iterableToArrayLimit(e,t){var a=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=a){var n,o,i=[],r=!0,s=!1;try{for(a=a.call(e);!(r=(n=a.next()).done)&&(i.push(n.value),!t||i.length!==t);r=!0);}catch(e){s=!0,o=e}finally{try{r||null==a.return||a.return()}finally{if(s)throw o}}return i}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function ownKeys(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),a.push.apply(a,n)}return a}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(a),!0).forEach(function(e){_defineProperty(t,e,a[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):ownKeys(Object(a)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))})}return t}function _defineProperty(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}require(["simplr","dpz.launchDarkly!external/ldclient.min","dpz.template","dpz.config","dpz.customer","dpz.oauth.constants","marketconfig/dpz.lang.customer"],function(O,e,t,a,n,o,i){function s(){return I()&&dpz.loyalty.isEnrolled()&&A("loyalty").isHighEngagementAvailable}function l(){return s()&&killConfig.isMarketEnabled("5a6fccb5-12f9-42bf-badf-7678a6b8f08b")}function L(){return s()&&killConfig.isMarketEnabled("0a7ac188-fc73-4884-9eca-59f066f5e148")}function R(){return s()&&killConfig.isMarketEnabled("ddd35f12-bccf-4bf1-b494-9af79d28761c")}function k(){return s()&&killConfig.isMarketEnabled("766f9d9c-602a-4a90-827c-61f806deaac5")}function r(){return s()&&killConfig.isMarketEnabled("8c954406-cfc0-4799-807c-ac81a70222c0")}function c(){var e=jsDPZ.app.customer.getCustomer().data;return!!this.loyaltyIsActive()&&(this.config.loyaltyIsOk&&void 0!==e.Session.loyaltyIsOk?e.Session.loyaltyIsOk:this.config.loyaltyIsOk)}function d(){return this.loyaltyIsOk()&&jsDPZ.app.customer.getCustomer().isLoyaltyCustomer()}function u(e){var t="",a="",n=e.Description.includes("${Points}");if(n){var o=e.Description.split("${Points}");t=o[0].trim(),a=o[1].trim()}return n&&"BASE"===e.Activity&&(e.Description="".concat(e.Points," ").concat(e.Description)),"MCSWEEPS"===e.TransactionType&&(e.isMasterCardSweeps=!0),_objectSpread(_objectSpread({},e),{},{description1:t,description2:a,dynamicDescription:n})}var _,y=t.translate,p=t.decodeAndSanitize,A=a.getMarketProperty,I=n.isProfiled,g=o.oauthSopes,m={signinURL:"#!/checkout/info/",activateURL:"#!/rewards/activate/",dashboardURL:"#!/customer/rewards/history/",warningWindowBase:30,history:{pageIndex:1,pageSize:2e3,separatePending:!0,hideLoading:!0,translations:{ADJUSTMENT:"customer.loyalty_activity_adjustment",BONUS:"customer.loyalty_activity_bonus",EXPIRATION:"customer.loyalty_activity_expired",NON_QUALIFYING_ORDER:"customer.loyalty_activity_non_qualifying",QUALIFYING_ORDER:"customer.loyalty_activity_qualifying",REDEMPTION:"customer.loyalty_activity_redemption",POINTS_RETURNED:"customer.loyalty_activity_returned"}},loyaltyIsOk:!0,enrollmentBonusConfig:{show:!1,bonusPoints:10,bonusTotalNeeds:10},defaultBase:{pointsPerOrder:10,totalNeeded:10,rewardPoints:60,rewardString:"customer.loyalty_reward_2m2t"},commands:{enroll:"LOYALTY_ENROLL",optOut:"LOYALTY_OPT_OUT",redeem:"LOYALTY_REDEEM",dashboard:"LOYALTY_VIEW_DASHBOARD",claimRewards:"CLAIM_REWARDS"},animation:{animate:!0,animateAllNewPizzas:!1,cache:"general",cachePrefix:"dpz_loyalty_",updateCache:function(){return!0}},widgetRulesSkeleton:{animation:{},data:{balance:{checkout:!1,useFullTitle:function(){return!1},showFullPoints:function(){return dpz.loyalty.animateWidgets("big")&&(1===dpz.loyalty.getPizzaCount()||dpz.loyalty.config.animation.animateAllNewPizzas)},hideAfterAnimation:function(){return!1}},pizzaCounter:{},redemption:{keepCoupons:!1,hideRedemption:function(){return!1}},points:{showTotalPoints:function(){return!0},showNextRewardPoints:function(){return!1},showPendingPoints:function(){return!0}},alerts:{showWarning:!0}},display:{balance:function(){return!0},pizzaCounter:function(){return!0},redemption:function(){return!0},points:function(){return!0},alerts:function(){return!0}},redirectToRewards:{balance:!0,pizzaCounter:!0,redemption:!1,points:!0,alerts:!0},parentSelector:""}},f={storeSelectionChanged:!1,isParticipating:function(){return jsDPZ.app.store.getStore().data.Pop}},x=function(e){var t=this.config.animation.animate,a=jsDPZ.app.customer.getCustomer().data,n=this.getCustomerPoints(),o=this.getPizzaCount();return t&&(void 0===a.Session.WidgetAnimation&&(a.Session.WidgetAnimation={}),_=this.config.animation.cachePrefix+e,t=!1!==a.Session.WidgetAnimation[_]&&site.func.hasCanvasSupport()&&(o<=1||0<n.RemainderPoints||this.config.animation.animateAllNewPizzas)),t};$(document).on("/breakpoint/change/handheld/ /breakpoint/change/desktop/ ",function(){dpz.loyalty.loyaltyIsActive()&&dpz.loyalty.updateWidgets()});function B(){return new Promise(function(o,i){var r=jsDPZ.app.customer.getCustomer,e=r().data.Session.highEngagementCampaignInfo;e?o(e):s()?jsDPZ.ajax.loyaltyProgram({type:"GET",url:"HE2021/customers/".concat(r().data.CustomerID)}).then(function(e){var t=e.data;if(null!=t&&t.attributes.campaignCustomers[0]){var a=r().data.Session,n=_objectSpread(_objectSpread({},t),{},{attributes:_objectSpread(_objectSpread({},t.attributes),{},{campaignCustomer:t.attributes.campaignCustomers[0]})});delete n.attributes.campaignCustomers,a.highEngagementCampaignInfo=n,site.sessionTools.save().then(function(){o(n)})}else i("Customer is not included in this campaign.")}).catch(i):i("Customer not eligible for this campaign.")})}function h(){return new Promise(function(n){l()||R()?B().then(function(e){var t=e.attributes.campaignCustomer,a=(t=void 0===t?{}:t).shownPromotionalModal;n(void 0===a||!a)}).catch(function(){n(!1)}):n(!1)})}function P(){return new Promise(function(i){r()?B().then(function(e){var t=e.id,a=e.type,n=e.attributes,o=jsDPZ.app.customer.getCustomer;n.campaignCustomer.bonusActivated?i(!1):jsDPZ.ajax.loyaltyProgram({data:JSON.stringify({data:{id:t,type:a,attributes:n}}),type:"PUT",url:"HE2021/customers/".concat(o().data.CustomerID)}).then(function(e){var t=e.data;o().data.Session.highEngagementCampaignInfo=t,site.sessionTools.save().then(function(){i(!0)})}).catch(function(){i(!1)})}).catch(function(){i(!1)}):i(!1)})}function C(o){require(["loyalty.components","dpz.template","marketconfig/dpz.lang.loyalty"],function(e,t,a){var n=e.TranslateContext;preact.render(preact.h(n.Provider,{value:t.getTranslateContextValue(_objectSpread({},a))},preact.h(o,null)),document.querySelector(".js-modalContainer"))},function(e){})}function v(){require(["loyalty.components"],function(e){var t=e.HighEngagement50OffModal,a=e.HighEngagementDoublePointsModal,n=jsDPZ.app.customer.getCustomer().data.Session.highEngagementCampaignInfo,o=(n=void 0===n?{}:n).attributes,i=(o=void 0===o?{}:o).campaignCustomer,r=void 0===i?{}:i;if(R())C(a);else{if(!l())return;C(t)}r.shownPromotionalModal=!0,site.sessionTools.save()})}function w(){require(["loyalty.components"],function(e){var t=e.HighEngagementWelcomeModal;C(t)})}return dpz.loyalty={animateWidgets:x,canEnroll:function(){return this.loyaltyIsOk()&&!this.isEnrolled()&&this.store.isParticipating()},canRedeem:function(e){var t,a,n,o,i,r=e||this.getBaseCoupon().CouponCode,s=jsDPZ.app.store.getStore().data.StoreID,l=this.store.isParticipating()||""===s,c=jsDPZ.app.customer.getCustomer().data.Loyalty.AccountStatus;return!(!this.isEnrolled()||"SUSPENDED"===c||""===r||!l)&&(t=this.getPizzaCount(),a=jsDPZ.app.order.getOrder().data.Details.Coupons,0<t&&(!(0<(n=a.reduce(function(e,t){return t.Code===r?e+t.Qty:e},0)))||((o=jsDPZ.app.catalog.getCatalog().getCoupon(r))&&o.data?(i=o.data.Tags.LimitPerOrder?parseInt(o.data.Tags.LimitPerOrder,10):1,jsDPZ.app.catalog.isCouponActive(r,killConfig.isMarketEnabled("afterMidnightCoupon")).Success&&n<i):!!(o=jsDPZ.app.customer.getCustomer().data.Loyalty.LoyaltyCoupons.find(function(e){return e.CouponCode===r}))&&n<(i=o.LimitPerOrder?o.LimitPerOrder:1))))},config:m,continueAnimation:function(e){function t(){$(o).find(".js-pizzasEarnedAnimOverlay").animate({width:"100%",height:"100%"},{queue:!1,duration:300,complete:function(){$(o).find(".js-pizzasEarnedAnimOverlay").hide()}}),$(o).find(".js-oldPizzasEarned").animate({top:"-100%"},{queue:!1}),$(o).find(".js-newPizzasEarned").animate({top:"50%"},{queue:!1,complete:function(){e&&(s.removeClass("inactive").removeAttr("disabled"),$(r).fadeIn())}})}var a=this.config.widgetRules.parentSelector,n=a+" .loyalty--widget-container--balance",o=a+" .loyalty--widget-container--pizza-counter",i=a+" .loyalty--widget-container--points",r=a+" .loyalty--widget-container--redemption",s=$(r).find(".js-loyaltyRedeem");2<=$(r).length&&(r=site.func.isHandheld()?a+" .loyalty--widget-container--redemption--handheld":a+" .loyalty--widget-container--redemption--desktop"),e?$(n).fadeOut({complete:function(){$(o).fadeIn({complete:function(){t()}}),$(i).show(),s.removeClass("inactive").removeAttr("disabled"),$(r).show()}}):(t(),dpz.loyalty.canRedeem()&&s.toggle({effect:"scale",duration:100,queue:!1,complete:function(){s.removeClass("inactive").removeAttr("disabled").toggle({effect:"scale",duration:200})}}))},doStopOver:function(){return this.loyaltyIsOk()&&site.func.customerLoggedIn()&&!d()&&this.store.isParticipating()||!site.func.customerLoggedIn()&&this.store.isParticipating()},eligibleFor50Off:l,eligibleFor5Off:L,eligibleForBOGO:k,eligibleForDoublePoints:R,eligibleForHighEngagement:s,eligibleForWelcome:r,enrollCustomer:function(e){var t=$.extend(!0,{},e),a=jsDPZ.app.customer.getCustomer().data;this.loyaltyIsOk()?($.extend(!0,a.Loyalty,{Command:"ENROLL"}),killConfig.isMarketEnabled("enrollmentSourceTag")&&t.EnrollmentSourceTag&&(a.EnrollmentSourceOrgUri=jsDPZ.config.dataModel.ORDER_REQUEST.SourceOrganizationURI,a.EnrollmentSourceTag=t.EnrollmentSourceTag),site.func.saveAccountData({data:a,success:function(e){e.Loyalty&&"Fail"!==e.Loyalty.Status?(jsDPZ.app.customer.getCustomer().data.Session.LoyaltyEnrollmentError&&jsDPZ.app.customer.getCustomer().data.Session.loyaltyStopover&&delete jsDPZ.app.customer.getCustomer().data.Session.LoyaltyEnrollmentError,jsDPZ.app.customer.getCustomer().data.Session.NewLoyaltyEnrollment=!0,site.sessionTools.save().then(function(){t.successCallback&&$.isFunction(t.successCallback)?t.successCallback():dpz.loyalty.loyaltyRedirect()})):(e.Loyalty||dpz.loyalty.updateLoyaltyStatus(!1),site.func.overlayToggle(!0,"codeOverlay",{},{code:"eLoyaltyEnrollmentFailed"}),t.errorCallback&&$.isFunction(t.errorCallback)&&t.errorCallback())},error:function(){t.errorCallback&&$.isFunction(t.errorCallback)&&t.errorCallback()}})):(site.func.overlayToggle(!0,"codeOverlay",{},{code:"eLoyaltyEnrollmentFailed"}),t.errorCallback&&$.isFunction(t.errorCallback)&&t.errorCallback())},fetchHighEngagement:B,generateLoyaltyDescription:u,getActivityString:function(e){var t;return null!=e&&""!==e?(t=e.toUpperCase(),this.config.history.translations[t]?this.config.history.translations[t]:e.replace("-"," ")):"&nbsp"},getBaseCoupon:function(){var e={CouponCode:"",PointValue:0,BaseCoupon:!1},t=jsDPZ.app.customer.getCustomer().data.Loyalty.LoyaltyCoupons;return this.loyaltyIsOk()&&this.isEnrolled()&&t&&t.find(function(e){return e.BaseCoupon})||e},getBasePoints:function(e){var t,a=e||this.getBaseCoupon().CouponCode,n=jsDPZ.app.customer.getCustomer().data.Loyalty.LoyaltyCoupons;return this.loyaltyIsOk()&&this.isEnrolled()&&n&&(t=n.find(function(e){return e.CouponCode===a}))&&t.PointValue||0},getCustomerPoints:function(){var e={BalancePoints:0,PendingPoints:0,RemainderPoints:0,HasEarnedNewPizza:!1},t=this.getBasePoints();return e.Potential=jsDPZ.app.order.getOrder().data.Details.Loyalty.Potential,e.BalancePoints=jsDPZ.app.customer.getCustomer().data.Loyalty.VestedPointBalance-e.Potential.Burn.RedemptionPoints,e.PendingPoints=jsDPZ.app.customer.getCustomer().data.Loyalty.PendingPointBalance,e.RemainderPoints=0<t?(jsDPZ.app.customer.getCustomer().data.Loyalty.VestedPointBalance-e.Potential.Burn.RedemptionPoints)%t:0,e.HasEarnedNewPizza=0===e.RemainderPoints&&0<e.BalancePoints,e},getEnrollmentBonusConfig:function(){return $.extend({show:!1,bonusPoints:0,bonusTotalNeeds:0},this.config.enrollmentBonusConfig)},getHistoryPoints:function(e){var t=e&&e.pageIndex?e.pageIndex:this.config.history.pageIndex,n=e&&e.separatePending?e.separatePending:this.config.history.separatePending,o=e&&e.successCallback?e.successCallback:function(){},i=e&&e.errorCallback?e.errorCallback:function(){};this.loyaltyIsActive()&&this.loyaltyIsOk()&&this.isEnrolled()?jsDPZ.ajax.fetchLoyaltyHistory({pageIndex:t,pageSize:this.config.history.pageSize,useCache:!1,success:function(e){function t(e){var t=$.extend({Description:"",OrderNumber:"",Points:"",PointBalance:"",PointStatus:"",TransactionDate:"",TransactionType:"",TransactionTotal:null,translateText:"",displayCustomerService:!1,showBalance:!0,rowClass:"",fullRowDescription:!1,isMasterCardSweeps:!1},e,{Points:e.Points||0,PointBalance:e.PointBalance||0});return(t=u(t)).activityClass="loyalty-history--cell--"+t.TransactionType.toLowerCase().replace(new RegExp(" ","g"),"-").replace(new RegExp("_","g"),"-"),t.pointStatusClass="loyalty-history--cell--"+t.PointStatus.toLowerCase(),t.translateText=t.TransactionType?dpz.loyalty.getActivityString(t.TransactionType):"",t.displayCustomerService="Expiration"===t.TransactionType,t.showTotal=t.TransactionTotal&&"0"!==t.TransactionTotal,t.fullRowDescription="Expiration"===t.TransactionType||"Customer Care"===t.TransactionType,t}var a={completedHistory:[],pendingHistory:[],fullHistory:(e.History||[]).map(function(e){return $.extend(!0,{},e,{TransactionDate:dayjs(e.TransactionDate).format("MM/DD/YY")})})};"Fail"!==e.Status?(n&&$.extend(!0,a,{pendingHistory:a.fullHistory.filter(function(e){return"PENDING"===e.PointStatus}).map(function(e){return $.extend(t(e),{showBalance:!1})}),completedHistory:a.fullHistory.filter(function(e){return"PENDING"!==e.PointStatus}).map(function(e){return $.extend(t(e),{rowClass:e.rowClass})})}),o(a)):i()},error:function(){i()}}):this.loyaltyIsOk()||i()},getNumberOfDaysBeforeShowingPointExpiration:function(){return parseInt(e.client.variation("034f6af4-03e3-4ef9-9c01-90366d5b17bf"))},getPercentage:function(){var e=this.getRawPercentage();return 100*e+"%"},getPizzaCount:function(e){var t=e?e.BalancePoints:this.getCustomerPoints().BalancePoints,a=this.getBasePoints();return t<0&&(t=0),0<a?Math.floor(t/a):0},getPointsRange:function(){var e=this.getBasePoints(),t={FloorPoints:0,CeilingPoints:0,BasePoints:e},a=this.getPizzaCount(this.getCustomerPoints());return t.FloorPoints=a*e,t.CeilingPoints=(a+1)*e,t},getRawPercentage:function(){var e=this.getCustomerPoints(),t=e.BalancePoints,a=this.getPizzaCount(e),n=this.getBasePoints(),o=0;return 0<n&&(o=e.HasEarnedNewPizza?1:(t-a*n)/n),o},getRedemptionTemplateMarkup:function(){return dpz.template.assembleLayout({component:"loyaltyWidgetPizzaRedeemed",tokens:{}})},getSmallWidgetRules:function(e){var t=0<arguments.length&&void 0!==e?e:{},a=t.isAllEntrees||window.location.hash.endsWith("/AllEntrees/");return $.extend(!0,this.config.widgetRulesSkeleton,{animation:{cache:"small"},data:{balance:{isAllEntrees:a,useFullTitle:function(){return site.func.isHandheld()},hideAfterAnimation:function(){return dpz.loyalty.getCustomerPoints().HasEarnedNewPizza},showFullPoints:function(){return dpz.loyalty.animateWidgets("small")&&(1===dpz.loyalty.getPizzaCount()||dpz.loyalty.config.animation.animateAllNewPizzas)}},redemption:{isAllEntrees:a,keepCoupons:!site.func.isHandheld()||!site.isHomepage,hideRedemption:function(){return(!site.isHomepage&&!a||!site.func.isHandheld())&&site.func.isHandheld()}},points:{isAllEntrees:a,showTotalPoints:function(){return!1},showNextRewardPoints:function(){return 60<=dpz.loyalty.getCustomerPoints().BalancePoints}},alerts:{showWarning:!1}},display:{balance:function(){var e=dpz.loyalty.getCustomerPoints();return e.BalancePoints<60||dpz.loyalty.animateWidgets("small")&&60===e.BalancePoints},pizzaCounter:function(){var e=dpz.loyalty.getCustomerPoints().BalancePoints;return 60<e||60===e&&!dpz.loyalty.animateWidgets("small")},redemption:function(){var e=dpz.loyalty.getCustomerPoints().BalancePoints;return 60<e||60===e&&!dpz.loyalty.animateWidgets("small")},points:function(){return 0<dpz.loyalty.getCustomerPoints().PendingPoints}}},t)},getWingsUpsell:function(d,e){var t=this.isEnrolled(),a=killConfig.isMarketEnabled("e3498fd2-e490-4041-8b57-64b66a3b4d0c"),n=A("loyalty").wings,o=Object.keys(n).includes(d),i=jsDPZ.app.customer.getCustomer().data,r=i.CustomerID,s=i.Session.sawLoyaltyWingsUpsell,u=jsDPZ.app.catalog.getCatalog(),l=u.data,y=l.Products,p=l.Variants,c=jsDPZ.app.order.getOrder().data.Details.Variants.some(function(e){var t,a=e.Code;return(null===(t=u.getVariant(a).data.Tags)||void 0===t?void 0:t.Wings)||!1});t&&a&&e&&o&&!s&&!c&&jsDPZ.ajax.loyaltyProgram({type:"GET",url:"Wings/customers/".concat(r)}).then(function(e){var c=_slicedToArray(e.data.attributes.campaignCustomers,1)[0];c&&require(["contexts.components","loyalty.components","dpz.template","marketconfig/dpz.lang.loyalty"],function(e,t,a,n){var o=e.withGNOLOContext,i=t.TranslateContext,r=t.LoyaltyWingsModal,s=A("loyalty").wings,l=o(r);preact.render(preact.h(i.Provider,{value:a.getTranslateContextValue(_objectSpread({},n))},preact.h(l,{addWingsToCart:function(e){var t=u.getVariant(e).data;O.controller.mRouteAndExecute("/order/variant/new".concat(site.catalogTools.orderVariantToURLParameterString(t)))},pointsAvailable:c.pointsAvailable,products:y,wingsCouponConfig:s[d],writeSawLoyaltyWingsUpsellToSession:function(){jsDPZ.app.customer.getCustomer().data.Session.sawLoyaltyWingsUpsell=!0,site.sessionTools.save()},variants:p})),document.body),_slicedToArray(document.getElementsByClassName("js-modal"),1)[0].scrollTop=0})}).catch(function(){})},hasLoyaltyCoupon:function(t){return jsDPZ.app.order.getOrder().data.Details.Coupons.some(function(e){return~e.Code.indexOf(t||"LTY")})},interceptWingRemoval:function(s){require(["contexts.components","loyalty.components","dpz.template","marketconfig/dpz.lang.loyalty"],function(e,t,a,n){var o=e.withGNOLOContext,i=t.TranslateContext,r=o(t.LoyaltyWingsConfirmationModal);preact.render(preact.h(i.Provider,{value:a.getTranslateContextValue(_objectSpread({},n))},preact.h(r,{removeVariant:s})),document.body),_slicedToArray(document.getElementsByClassName("js-modal"),1)[0].scrollTop=0})},shouldShowHighEngagementPromotionalModal:h,shouldShowHighEngagementWelcomeModal:P,isEnrolled:d,isLastActivityInsideWarningTime:function(){var e,t,a;return!(!this.isEnrolled()||(e=dayjs(dayjs().format("YYYY-MM-DD"),"YYYY-MM-DD"),!(t=dayjs(jsDPZ.app.customer.getCustomer().data.Loyalty.BasePointExpirationDate,"YYYY-MM-DD")).isValid()))&&((a=dayjs(e).add(this.config.warningWindowBase,"days")).isSame(t)||a.isAfter(t)&&(t.isAfter(e)||t.isSame(e)))},isReroute:function(){return jsDPZ.app.customer.getCustomer().data.Session.LoyaltyRedirect&&""!==jsDPZ.app.customer.getCustomer().data.Session.LoyaltyRedirect},loyaltyIsActive:function(){return killConfig.isMarketEnabled("loyalty")},loyaltyIsOk:c,loyaltyRedirect:function(e){var t,a=site.func.customerLoggedIn(),n=site.func.customerSemiLoggedIn();e&&(jsDPZ.app.customer.getCustomer().data.Session.LoyaltyRedirect=e,site.sessionTools.save()),t=jsDPZ.app.customer.getCustomer().data.Session.LoyaltyRedirect,(a||n)&&this.store.isParticipating(),a||n?(a||n)&&dpz.loyalty.isEnrolled()&&(t=jsDPZ.app.customer.getCustomer().data.Session.LoyaltyRedirect,jsDPZ.app.customer.getCustomer().data.Session.LoyaltyRedirect="",site.sessionTools.save()):t=m.signinURL,"#"===t[0]?window.location.hash=t:window.location=t},notifyLoginError:function(){this.loyaltyIsActive()&&!1===jsDPZ.app.customer.getCustomer().data.Session.loyaltyIsOk&&site.func.overlayToggle(!0,"codeOverlay",{},{code:"eLoyaltyLoginFailed"})},pizzaRedemptionAnimation:function(){var n=$(".js-smallWidgetBody:visible"),o=n.html(),e=this.getRedemptionTemplateMarkup(),i=$.Deferred(),r=$.Deferred();return $(n).css("height",n.outerHeight()),e.then(function(a){n.fadeTo(250,0,function(){var e,t;n.html(a),e=n.find(".js-pizzaRedeemedText"),t=e.outerHeight(),n.css("opacity",1),n.animate({height:t},function(){e.toggleClass("small-scale-hidden full-scale"),e.one("webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend",function(){setTimeout(function(){e.removeClass("full-scale").addClass("small-scale-transition"),e.one("webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend",function(){n.css({opacity:0,maxHeight:t,height:"auto"}).html(o),dpz.loyalty.getPizzaCount()<1&&0<dpz.loyalty.getCustomerPoints().RemainderPoints?setTimeout(function(){dpz.loyalty.updateWidgets({data:{balance:{checkout:-1<window.location.hash.indexOf("/checkout/")}}},{forceAnimation:!0}),i.resolve()},1e3):(dpz.loyalty.updateWidgets({},{animateButton:1<=dpz.loyalty.getPizzaCount()}),i.resolve()),n.animate({maxHeight:1e3,opacity:1},1e3,function(){$(this).removeAttr("style"),r.resolve()})})},500)})})})}),$.when(i,r)},positionBarEndcap:function(){var e=this.getRawPercentage();return 100*e-6+"%"},redirectToRewards:function(){this.loyaltyIsActive()&&(site.func.customerSemiLoggedIn()&&!dpz.oauth.isAuthorized([g.UPDATE_PROFILE])()?site.func.showLoginPopup({successCommand:dpz.loyalty.config.commands.dashboard}):~window.location.href.indexOf("/pages/customer/")?~window.location.hash.indexOf(this.config.dashboardURL)||(window.location.hash=this.config.dashboardURL):window.location.href=urlConfig.root+"/pages/customer/"+this.config.dashboardURL)},refreshLoyaltyStatus:function(){var t=$.Deferred(),a=jsDPZ.app.customer.getCustomer().data;return this.loyaltyIsActive()&&I()&&(this.config.loyaltyIsOk?jsDPZ.ajax.fetchLoyaltySummary(a.CustomerID).done(function(e){$.extend(!0,a.Loyalty,e),delete a.Loyalty.CustomerID,site.sessionTools.save().then(function(){dpz.loyalty.updateLoyaltyStatus(!0),t.resolve()})}).fail(function(){dpz.loyalty.updateLoyaltyStatus(!1),site.func.overlayToggle(!0,"codeOverlay",{},{code:"eLoyaltyLoginFailed"}),t.reject()}):(dpz.loyalty.updateLoyaltyStatus(!1),site.func.overlayToggle(!0,"codeOverlay",{},{code:"eLoyaltyLoginFailed"}),t.reject())),t},renderSmallWidget:function(e){var t=$.extend(!0,{selector:".js-myLoyaltyWidget",updateData:{}},e);O.view.mRender({name:"loyalty_small_widget",data:t.updateData,selector:t.selector})},resetOrderEarnPoints:function(){this.loyaltyIsOk()&&this.isEnrolled()&&($.extend(!0,jsDPZ.app.order.getOrder().data.Details.Loyalty,{Potential:{Earn:jsDPZ.config.dataModel.ORDER.Details.Loyalty.Potential.Earn}}),site.sessionTools.save())},renderHighEngagementPromotionalModal:v,renderHighEngagementWelcomeModal:w,setWidgetRules:function(e){this.config.widgetRules=$.extend(!0,{},this.config.widgetRulesSkeleton,{animation:this.config.animation},{animation:{updateCache:function(){return!site.func.isHandheld()}}},e)},shouldInterceptWingRemoval:function(a){function n(e){return t.getVariant(e).data.Tags.Wings||!1}var t=jsDPZ.app.catalog.getCatalog(),e=n(a.Code),o=jsDPZ.app.customer.getCustomer().data.Session.sawLoyaltyWingsUpsell,i=0===jsDPZ.app.order.getOrder().data.Details.Variants.filter(function(e){var t=e.Code;return a.Code!==t&&n(t)}).length,r=10<=jsDPZ.app.order.getOrder().data.Details.Amounts.Customer;return e&&this.isEnrolled()&&o&&i&&r},showInfographicOverlay:function(e){var t=0<arguments.length&&void 0!==e?e:{};if(this.loyaltyIsActive()){var a=t.currentTarget,n=void 0===a?null:a;site.func.overlayToggle(!0,"contentOverlay",{},{template:"loyaltyInfographic",templateData:{customClass:"loyalty-infographic--overlay",showBanner:!0,focusedElement:n},title:p(y("customer.create_feature_loyalty_title",null,i)),titleClass:"is-visually-hidden"},function(){site.func.stackAttack(" .loyalty-infographic--overlay")})}},store:f,updateLoyaltyStatus:function(e){var t;jsDPZ.app.customer.getCustomer().data.Session.loyaltyIsOk=e,$.when(t).done(function(){site.sessionTools.save().then(function(){site.isHomepage||dpz.loyalty.updateWidgets(),jsDPZ.topic("loyalty.status.changed").publish({status:e})})})},updateOrderPoints:function(){var t=$.Deferred();return this.loyaltyIsOk()&&this.isEnrolled()?site.func.getOrderForPowerData({calculatePotentialPoints:!0}).then(function(e){jsDPZ.ajax.priceOrder({data:e}).then(function(e){if(0<=e.Status)e.Order&&e.Order.Loyalty?e.Order.Loyalty.Status&&"Fail"===e.Order.Loyalty.Status?t.reject(e):($.extend(!0,jsDPZ.app.order.getOrder().data.Details.Loyalty,{Potential:e.Order.Loyalty.Potential||jsDPZ.config.dataModel.ORDER.Details.Loyalty.Potential,Burn:e.Order.Loyalty.Burn||jsDPZ.config.dataModel.ORDER.Details.Loyalty.Burn,Earn:e.Order.Loyalty.Earn||jsDPZ.config.dataModel.ORDER.Details.Loyalty.Earn,PendingBalance:e.Order.Loyalty.PendingBalance||jsDPZ.config.dataModel.ORDER.Details.Loyalty.PendingBalance,PointBalance:e.Order.Loyalty.PointBalance||jsDPZ.config.dataModel.ORDER.Details.Loyalty.PointBalance}),site.sessionTools.save(),t.resolve()):t.reject(e);else{if(e.Order.StatusItems.some(function(e){return"PosOrderIncomplete"===e.Code&&6===e.PulseCode}))return $.extend(!0,jsDPZ.app.order.getOrder().data.Details.Loyalty,{Potential:jsDPZ.config.dataModel.ORDER.Details.Loyalty.Potential,Burn:jsDPZ.config.dataModel.ORDER.Details.Loyalty.Burn,Earn:jsDPZ.config.dataModel.ORDER.Details.Loyalty.Earn,PendingBalance:jsDPZ.config.dataModel.ORDER.Details.Loyalty.PendingBalance,PointBalance:jsDPZ.config.dataModel.ORDER.Details.Loyalty.PointBalance}),site.sessionTools.save(),void t.resolve();t.reject(e)}},function(){t.reject()})}):t.reject(),t},updateWidgets:function(c,d){var u,y,p,g,m,f,h,P,C,v,w,b,D,j,S=this,z=$.extend({keepCoupons:!1},c),E=jsDPZ.app.customer.getCustomer().data,e=E.Session.customerFetchedDetails,T={toggleLoadingBar:z.toggleLoadingBar},r=jsDPZ.app.customer.getCustomer;if(killConfig.isMarketEnabled("customerDetailsApiCall")&&!e){function t(){r().fetchCustomerDetails(T).then(function(){return r().data.Session.customerFetchedDetails=!0,site.sessionTools.save()})}I()?t():$(document).on("customerLogin.success",t)}return!c&&this.config.widgetRules||this.setWidgetRules($.extend({},c)),u=this.config.widgetRules,this.isEnrolled()?(u.parentSelector,x=this.config.animation.animate,p=u.parentSelector,f="".concat(p," .loyalty--widget-container--balance"),h="".concat(p," .loyalty--widget-container--pizza-counter"),C="".concat(p," .loyalty--widget-container--points"),P="".concat(p," .loyalty--widget-container--redemption"),2<=$(P).length&&(P=site.func.isHandheld()?"".concat(p," .loyalty--widget-container--redemption--handheld"):"".concat(p," .loyalty--widget-container--redemption--desktop")),v="".concat(p," .loyalty--widget-container--alerts"),dpz.util.isEmpty(E.Session.WidgetAnimation)&&(E.Session.WidgetAnimation={}),$.extend(this.config.animation,z.animation),y=d&&d.forceAnimation||dpz.loyalty.animateWidgets(this.config.animation.cache),_=this.config.animation.cachePrefix+this.config.animation.cache,w=y&&this.getCustomerPoints().HasEarnedNewPizza,g=$(f).data("widget-modifier"),m=$(h).data("widget-modifier"),site.func.isHandheld()&&(g=$(f).data("widget-handheld-modifier"),m=$(h).data("widget-handheld-modifier")),jsDPZ.ajax.fetchLoyaltySummary(_objectSpread(_objectSpread({},T),{},{value:E.CustomerID})).then(function(e){return E.Loyalty=_objectSpread(_objectSpread({},E.Loyalty),e),delete E.Loyalty.CustomerID,site.sessionTools.save()}).then(function(){return $.Deferred(function(e){var t,i=e.resolve;null!==(t=A("loyalty").twoOrdersAway)&&void 0!==t&&t.isEnabled?jsDPZ.app.customer.getCustomer().data.Session.twoOrdersAwayPostClaim?i(!0):killConfig.isMarketEnabled("e4baca08-cedb-4c9d-99a3-531969c857bf")?jsDPZ.ajax.loyaltyProgram({type:"GET",url:"TwoOrdersAway/customers/".concat(r().data.CustomerID)}).then(function(e){var t=e.data,a=t.attributes.campaignCustomers[0],n=t.attributes.bonusActivated,o=t.attributes.programName;a?(!n&&o===r().data.Session.activateProgram&&t.attributes.campaignCustomers.length&&(jsDPZ.app.customer.getCustomer().data.Session.twoOrdersAwayEmailActivation=!0),i(!0)):i(!1)}).catch(function(){i(!1)}):i(!1):i(!1)})}).then(function(e){function t(){var s=document.querySelector("".concat(p," .js-bandJumper"));killConfig.isMarketEnabled("5414583f-a81f-438f-8305-57f119679147")&&s&&require(["loyalty.components","dpz.template","marketconfig/dpz.lang.loyalty"],function(e,t,a){var n=e.BandJumper,o=e.BandJumperProvider,i=e.TranslateContext,r=A("loyalty").bandJumper;preact.render(preact.h(i.Provider,{value:t.getTranslateContextValue(_objectSpread({},a))},preact.h(o,{config:r,customer:jsDPZ.app.customer.getCustomer().data,languageCode:dpz.market.activeLanguageCode,programRequest:function(e){return jsDPZ.ajax.loyaltyProgram(_objectSpread(_objectSpread({},e),T))},removeActivateProgramFromSession:function(){delete jsDPZ.app.customer.getCustomer().data.Session.activateProgram,site.sessionTools.save()},utag:dpz.utag},preact.h(n,null))),s)});var l=document.querySelector("".concat(p," .js-appOrderBonus"));site.isHomepage&&"en"==dpz.market.activeLanguageCode&&killConfig.isMarketEnabled("0e319703-7de6-471a-8f2b-e4f884796ae8")&&l&&require(["loyalty.components","dpz.template","marketconfig/dpz.lang.loyalty"],function(e,t,a){var n=e.AppOrderBonus,o=e.AppOrderBonusProvider,i=e.TranslateContext,r=A("loyalty").appOrderBonus;preact.render(preact.h(i.Provider,{value:t.getTranslateContextValue(_objectSpread({},a))},preact.h(o,{config:r,customer:jsDPZ.app.customer.getCustomer().data,languageCode:dpz.market.activeLanguageCode,programRequest:function(e){return jsDPZ.ajax.loyaltyProgram(_objectSpread(_objectSpread({},e),T))},sendSMSMessageRequest:function(e){return jsDPZ.ajax.sendSMSMessage(_objectSpread(_objectSpread({},e),T))},site:site,urlConfig:urlConfig,utag:dpz.utag},preact.h(n,null))),l)});var r=document.querySelector("".concat(p," .js-highEngagement"));site.isHomepage&&r&&(k()||L()&&!R())&&B().then(function(){require(["loyalty.components","dpz.template","marketconfig/dpz.lang.tiles"],function(e,t,a){var n=e.HighEngagementBOGOTile,o=e.HighEngagement5OffTile,i=e.TranslateContext;L()?preact.render(preact.h(i.Provider,{value:t.getTranslateContextValue(_objectSpread({},a))},preact.h(o,{urlConfig:urlConfig,utag:dpz.utag})),r):k()&&preact.render(preact.h(i.Provider,{value:t.getTranslateContextValue(_objectSpread({},a))},preact.h(n,{urlConfig:urlConfig,utag:dpz.utag})),r)})}).catch(function(){})}if(e){var a="",n=window.location.hash,o=n.includes("/checkout/"),i=n.includes("/section/Coupons/"),r=n.includes("/section/Food/category/"),s=n.includes("/customer/profile")||n.includes("/customer/rewards");a=site.isHomepage&&!site.func.isHandheld()||s?"".concat(p," .loyalty__dashboard"):".js-loyalty-widgets-container";var l="";return site.func.isHandheld()?l="loyalty-two-orders-away--condensed":(r||o||i)&&(l="loyalty-two-orders-away--small-column-layout"),O.view.mRender({name:"loyalty_widget_two_orders_away",data:$.extend({},u.data.balance,{animate:y,newPizzaAnimation:S.config.animation.animateAllNewPizzas,modifierClass:l,isCondensedWidget:c&&c.isCondensedWidget,utag:dpz.utag}),selector:a}),void t()}O.view.mRender({name:"loyalty_widget_balance",data:$.extend({},u.data.balance,{animate:y,newPizzaAnimation:S.config.animation.animateAllNewPizzas,modifierClass:g,isCondensedWidget:c&&c.isCondensedWidget}),selector:f}),O.view.mRender({name:"loyalty_widget_pizza_counter",data:$.extend({},u.data.pizzaCounter,{willBeAnimated:w,modifierClass:m}),selector:h}),O.view.mRender({name:"loyalty_widget_points",data:$.extend({},u.data.points,_objectSpread(_objectSpread({},T),{},{isCondensedWidget:c&&c.isCondensedWidget})),selector:C}),O.view.mRender({name:"loyalty_widget_redemption",data:$.extend({},u.data.redemption,_objectSpread(_objectSpread({},T),{},{willBeAnimated:w})),selector:P}),O.view.mRender({name:"loyalty_widget_alerts",data:$.extend({},u.data.alerts),selector:v}),t(),(D=S.loyaltyIsOk())&&u.display.balance()?$(f).show():$(f).hide(),D&&u.display.pizzaCounter()?$(h).show():$(h).hide(),D&&u.display.points()?$(C).show():$(C).hide(),D&&u.display.redemption()?$(P).show():$(P).hide(),D&&S.canRedeem()&&d&&d.animateButton&&$(P).addClass("small-scale-hidden"),u.display.alerts()||!D?$(v).show():$(v).hide(),~P.indexOf("handheld")?$("".concat(p," .loyalty--widget-container--redemption--desktop")).hide():~P.indexOf("desktop")&&$("".concat(p," .loyalty--widget-container--redemption--handheld")).hide(),site.func.hasCanvasSupport()||$(f+", "+h).addClass("widget__fallback"),$("".concat(f,", ").concat(h,", ").concat(C,", ").concat(P,", ").concat(v)).off("click.redirectToRewards").off("keyup.redirectToRewards"),S.loyaltyIsOk()&&(b=[],u.redirectToRewards.balance&&u.display.balance()&&b.push(f),u.redirectToRewards.pizzaCounter&&u.display.pizzaCounter()&&b.push(h),u.redirectToRewards.redemption&&u.display.redemption()&&b.push(P),u.redirectToRewards.points&&u.display.points()&&b.push(C),u.redirectToRewards.alerts&&u.data.alerts.showWarning&&b.push(v),$(b.join(",")).on("click.redirectToRewards",function(e){e.preventDefault(),dpz.loyalty.redirectToRewards()}),$(b.join(",")).on("keyup.redirectToRewards",function(e){13!==e.which&&32!==e.which||dpz.loyalty.redirectToRewards()})),site.func.isHandheld()&&!dpz.loyalty.canRedeem()&&jsDPZ.topic("render.redemption").subscribe(function(){P="".concat(p," .js-loyalty-widget-handheld-redemption"),O.view.mRender({name:"loyalty_widget_redemption",data:$.extend({},u.data.redemption,_objectSpread(_objectSpread({},T),{},{willBeAnimated:w})),selector:P})}),z.showInfo&&(j=z.showInfo.pageName?z.showInfo.pageName:"",$(".loyalty-icon-info").off("click.loyaltyWidget").on("click.loyaltyWidget",function(){var e=j||utag.data.page_name,t=$.extend(!0,{title:"LoyaltyWidget "+e,group:"Loyalty Widget",subGroup:e+" Show Info",uri:"LoyaltyWidget/"+e+"/ShowInfo"},z.showInfo.webTrendEvent);site.trigger.onEvent(t),$.isFunction(z.showInfo.callback)&&z.showInfo.callback()})),D&&S.canRedeem()&&d&&d.animateButton&&setTimeout(function(){$(P).toggleClass("small-scale-hidden full-scale"),$(P).one("webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend",function(){$(this).removeClass("full-scale")})},500),0!==$(".js-loyalty-widgets-container").length&&"none"===!$(".js-loyalty-widgets-container").css("display")||!u.animation.updateCache()||(E.Session.WidgetAnimation[_]=!1),site.sessionTools.save()})):$.Deferred()}},site.isHomepage||$(document).on("customerLogin.success",function(){h().then(function(e){e?v():P().then(function(e){e&&w()})})}),dpz.loyalty});